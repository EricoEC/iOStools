<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>苹果钱包 PKPass 生成器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; }
        body { max-width: 900px; margin: 2rem auto; padding: 0 1rem; background: #f8f9fa; }
        .container { background: white; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #1d1d1f; margin-bottom: 2rem; font-size: 1.8rem; }
        .form-group { margin-bottom: 1.8rem; }
        label { display: block; margin-bottom: 0.7rem; font-weight: 600; color: #333; font-size: 0.95rem; }
        input, select, textarea, button { width: 100%; padding: 0.9rem; border: 1px solid #e5e5e7; border-radius: 8px; font-size: 1rem; background: #fff; }
        textarea { min-height: 90px; resize: vertical; line-height: 1.5; }
        select { color: #333; cursor: pointer; }
        button { background: #0071e3; color: white; border: none; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        button:hover { background: #0077ed; }
        .toggle-btn { background: #f5f5f7; color: #1d1d1f; margin-bottom: 1.5rem; }
        .toggle-btn:hover { background: #e8e8ed; }
        .advanced-group { display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px dashed #e5e5e7; }
        .checkbox-group { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1rem; }
        .checkbox-group input { width: auto; height: 18px; width: 18px; cursor: pointer; }
        .checkbox-group label { margin: 0; font-weight: 400; color: #555; }
        .color-group { display: flex; gap: 1rem; margin-top: 0.5rem; }
        .color-group input { padding: 0.3rem; height: 45px; }
        .preview { margin-top: 1rem; padding: 1rem; border: 1px solid #e5e5e7; border-radius: 8px; text-align: center; }
        .preview img { max-height: 80px; border-radius: 6px; margin: 0.5rem 0; }
        #debugInfo { margin: 1.5rem 0; padding: 1rem; border-radius: 8px; display: none; font-size: 0.95rem; }
        .debug-success { background: #e6fffa; color: #26a69a; border: 1px solid #b2f5ea; }
        .debug-error { background: #ffebee; color: #e53935; border: 1px solid #ffcdd2; }
        .download-group { display: flex; gap: 1.2rem; margin-top: 2rem; }
        .download-group button { flex: 1; padding: 1rem; }
        .install-link { display: block; text-align: center; margin-top: 1.5rem; color: #0071e3; text-decoration: none; font-weight: 600; padding: 0.9rem; border: 1px solid #0071e3; border-radius: 8px; transition: all 0.2s; }
        .install-link:hover { background: #f0f8ff; }
        .warning { color: #ff9800; margin-top: 0.5rem; font-size: 0.85rem; line-height: 1.4; }
        .tip { color: #666; margin-top: 0.5rem; font-size: 0.85rem; }
    </style>
    <!-- 二维码生成依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- ZIP打包依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>苹果钱包 PKPass 生成器</h1>

        <!-- 普通模式：基础信息 -->
        <div class="form-group">
            <label for="passType">卡包类型</label>
            <select id="passType" required>
                <option value="membership">会员卡</option>
                <option value="coupon">优惠券</option>
                <option value="eventTicket">门票</option>
            </select>
        </div>
        <div class="form-group">
            <label for="passName">卡包名称（钱包内显示）</label>
            <input type="text" id="passName" placeholder="例如：星巴克会员卡、XX优惠券" required>
        </div>
        <div class="form-group">
            <label for="passTitle">卡面主标题</label>
            <input type="text" id="passTitle" placeholder="例如：尊贵会员、满100减50" required>
        </div>
        <div class="form-group">
            <label for="passCode">核心码（卡号/券码/门票码）</label>
            <input type="text" id="passCode" placeholder="例如：1008611、YH2025001" required>
            <div class="tip">此码会显示在卡面核心位置，同时生成对应二维码</div>
        </div>

        <!-- 高级模式开关 -->
        <button class="toggle-btn" id="advancedToggle">展开高级配置 ▼</button>

        <!-- 高级模式：所有自定义项 -->
        <div class="advanced-group" id="advancedGroup">
            <!-- 卡面样式 -->
            <div class="form-group">
                <label>卡面颜色（16进制色值，不带#）</label>
                <div class="color-group">
                    <input type="text" id="bgColor" placeholder="背景色，如：FF5722" value="FF5722">
                    <input type="text" id="textColor" placeholder="文字色，如：FFFFFF" value="FFFFFF">
                    <input type="text" id="stripColor" placeholder="条纹色，如：E64A19" value="E64A19">
                </div>
                <div class="tip">建议背景色选深色，文字色选白色，保证显示清晰</div>
            </div>

            <!-- 图片上传 -->
            <div class="form-group">
                <label for="logoUpload">卡面Logo（建议100x100 PNG，透明背景，<100KB）</label>
                <input type="file" id="logoUpload" accept="image/png">
                <div class="preview" id="logoPreview">Logo预览</div>
            </div>
            <div class="form-group">
                <label for="bgUpload">卡面背景图（建议600x300 PNG，<200KB）</label>
                <input type="file" id="bgUpload" accept="image/png">
                <div class="preview" id="bgPreview">背景预览</div>
            </div>

            <!-- 文字信息 -->
            <div class="form-group">
                <label for="passSubtitle">卡面副标题</label>
                <input type="text" id="passSubtitle" placeholder="例如：全国通用、2026年有效">
            </div>
            <div class="form-group">
                <label for="passDescription">卡包描述（钱包内点击查看详情显示）</label>
                <textarea id="passDescription" placeholder="例如：本会员卡为XX品牌通用会员凭证，凭码可享受会员折扣；本优惠券有效期至2026年12月31日，不与其他活动叠加"></textarea>
            </div>

            <!-- 有效期 -->
            <div class="form-group">
                <label for="expireDate">卡包有效期（选填，格式：2026-12-31）</label>
                <input type="date" id="expireDate">
                <div class="tip">不填则为永久有效</div>
            </div>

            <!-- 二维码/条形码 -->
            <div class="form-group">
                <label for="codeType">码类型</label>
                <select id="codeType">
                    <option value="QR_CODE">二维码（默认）</option>
                    <option value="CODE_128">条形码</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="showCode" checked>
                <label for="showCode">卡面显示核心码文本</label>
            </div>

            <!-- 辅助字段 -->
            <div class="form-group">
                <label for="auxField1">辅助字段1（选填，如：门店地址/使用规则）</label>
                <input type="text" id="auxField1" placeholder="左侧文字：右侧内容，如：门店地址：北京市朝阳区XX路">
            </div>
            <div class="form-group">
                <label for="auxField2">辅助字段2（选填）</label>
                <input type="text" id="auxField2" placeholder="如：咨询电话：400-000-0000">
            </div>
        </div>

        <!-- 调试信息 -->
        <div id="debugInfo"></div>

        <!-- 下载/添加按钮 -->
        <div class="download-group">
            <button id="generateBtn">生成 PKPass 文件</button>
            <button id="zipBtn">打包 ZIP 下载</button>
        </div>
        <a href="#" id="addLink" class="install-link" style="display: none;">Safari 直接添加到苹果钱包</a>
    </div>

    <script>
        let currentPassBlob = null;
        let currentPassName = '';
        // 高级模式切换
        const advancedToggle = document.getElementById('advancedToggle');
        const advancedGroup = document.getElementById('advancedGroup');
        advancedToggle.addEventListener('click', () => {
            const isOpen = advancedGroup.style.display === 'block';
            advancedGroup.style.display = isOpen ? 'none' : 'block';
            advancedToggle.textContent = isOpen ? '展开高级配置 ▼' : '收起高级配置 ▲';
        });

        // 图片预览 + 转Base64
        function previewAndToBase64(fileInput, previewEl) {
            return new Promise((resolve, reject) => {
                const file = fileInput.files[0];
                if (!file) return resolve('');
                // 大小限制
                if (file.size > 200 * 1024) return reject('图片超过200KB限制');
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewEl.innerHTML = `<img src="${e.target.result}" alt="预览">`;
                    resolve(e.target.result.split(',')[1]);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        // Logo预览
        document.getElementById('logoUpload').addEventListener('change', async () => {
            await previewAndToBase64(document.getElementById('logoUpload'), document.getElementById('logoPreview'));
        });
        // 背景预览
        document.getElementById('bgUpload').addEventListener('change', async () => {
            await previewAndToBase64(document.getElementById('bgUpload'), document.getElementById('bgPreview'));
        });

        // 生成唯一ID（PKPass要求）
        function generatePassId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // 解析辅助字段
        function parseAuxField(str) {
            if (!str || !str.includes('：')) return null;
            const [label, value] = str.split('：');
            return label.trim() && value.trim() ? { label, value } : null;
        }

        // 生成PKPass核心文件：pass.json
        async function generatePassJson() {
            // 普通字段
            const passType = document.getElementById('passType').value;
            const passName = document.getElementById('passName').value.trim();
            const passTitle = document.getElementById('passTitle').value.trim();
            const passCode = document.getElementById('passCode').value.trim();
            // 高级字段
            const bgColor = document.getElementById('bgColor').value.trim() || 'FF5722';
            const textColor = document.getElementById('textColor').value.trim() || 'FFFFFF';
            const stripColor = document.getElementById('stripColor').value.trim() || 'E64A19';
            const passSubtitle = document.getElementById('passSubtitle').value.trim();
            const passDescription = document.getElementById('passDescription').value.trim() || passName;
            const expireDate = document.getElementById('expireDate').value;
            const codeType = document.getElementById('codeType').value;
            const showCode = document.getElementById('showCode').checked;
            const auxField1 = parseAuxField(document.getElementById('auxField1').value);
            const auxField2 = parseAuxField(document.getElementById('auxField2').value);

            // 图片Base64
            const logoBase64 = await previewAndToBase64(document.getElementById('logoUpload'), document.getElementById('logoPreview')).catch(() => '');
            const bgBase64 = await previewAndToBase64(document.getElementById('bgUpload'), document.getElementById('bgPreview')).catch(() => '');

            // 构造pass.json核心结构（遵循苹果PKPass官方规范）
            const passJson = {
                formatVersion: 1,
                passTypeIdentifier: `pass.com.${generatePassId()}`, // 测试版虚拟ID
                serialNumber: generatePassId(), // 唯一序列号
                teamIdentifier: 'T123456789', // 测试版虚拟团队ID
                organizationName: 'PKPass生成器',
                description: passDescription,
                name: passName,
                [passType]: {
                    primaryFields: [
                        {
                            key: 'code',
                            label: '码',
                            value: passCode,
                            displayPriority: 1
                        }
                    ],
                    secondaryFields: passSubtitle ? [{
                        key: 'subtitle',
                        label: '',
                        value: passSubtitle,
                        displayPriority: 2
                    }] : [],
                    auxiliaryFields: []
                },
                barcodes: [
                    {
                        format: codeType,
                        message: passCode,
                        messageEncoding: 'UTF-8',
                        altText: showCode ? passCode : ''
                    }
                ],
                backgroundColor: `#${bgColor}`,
                foregroundColor: `#${textColor}`,
                stripColor: `#${stripColor}`,
                isRemotePass: false
            };

            // 添加有效期
            if (expireDate) passJson.expirationDate = new Date(expireDate).toISOString();
            // 添加辅助字段
            if (auxField1) passJson[passType].auxiliaryFields.push({ key: 'aux1', label: auxField1.label, value: auxField1.value, displayPriority: 3 });
            if (auxField2) passJson[passType].auxiliaryFields.push({ key: 'aux2', label: auxField2.label, value: auxField2.value, displayPriority: 4 });
            // 添加卡面主标题
            passJson[passType].primaryFields.unshift({
                key: 'title',
                label: '',
                value: passTitle,
                displayPriority: 0
            });

            return { passJson, logoBase64, bgBase64, passName };
        }

        // 生成PKPass文件（打包所有资源为.zip，改后缀.pkpass）
        async function generatePKPass() {
            const debugEl = document.getElementById('debugInfo');
            debugEl.style.display = 'block';
            debugEl.className = '';

            // 基础校验
            const passName = document.getElementById('passName').value.trim();
            const passTitle = document.getElementById('passTitle').value.trim();
            const passCode = document.getElementById('passCode').value.trim();
            if (!passName || !passTitle || !passCode) {
                debugEl.className = 'debug-error';
                debugEl.textContent = '❌ 错误：请填写卡包名称、主标题、核心码';
                return null;
            }

            try {
                // 生成pass.json和资源
                const { passJson, logoBase64, bgBase64, passName: finalPassName } = await generatePassJson();
                currentPassName = finalPassName;
                const zip = new JSZip();

                // 添加核心文件：pass.json
                zip.file('pass.json', JSON.stringify(passJson, null, 2), { encoding: 'utf8' });
                // 添加图片资源（PKPass要求固定文件名）
                if (logoBase64) zip.file('logo.png', logoBase64, { base64: true });
                if (bgBase64) zip.file('background.png', bgBase64, { base64: true });
                // 必加默认图标（防止iOS解析失败）
                zip.file('icon.png', 'iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFHGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOk9wZW4gYmFzZWxpbmU9IjE1IiBzdHJva2U9IiMwMDAwMDAiIHN0cm9rZS13aWR0aD0iMSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48L3RpZmY6T3Blbj4KICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+', { base64: true });

                // 打包为blob（PKPass本质是zip包，改后缀即可）
                const passBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                });

                debugEl.className = 'debug-success';
                debugEl.textContent = '✅ PKPass文件生成成功，iOS Safari可直接添加到钱包';
                return passBlob;
            } catch (e) {
                debugEl.className = 'debug-error';
                debugEl.textContent = `❌ 生成失败：${e.message}`;
                return null;
            }
        }

        // 下载文件
        function downloadFile(blob, filename, mimeType) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            return blob;
        }

        // 生成PKPass按钮
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const passBlob = await generatePKPass();
            if (!passBlob) return;
            currentPassBlob = passBlob;
            // 下载.pkpass文件
            downloadFile(passBlob, `${currentPassName}.pkpass`, 'application/vnd.apple.pkpass');
            // 显示添加到钱包链接
            document.getElementById('addLink').style.display = 'block';
            document.getElementById('addLink').href = URL.createObjectURL(passBlob);
        });

        // 打包ZIP按钮
        document.getElementById('zipBtn').addEventListener('click', async () => {
            const passBlob = await generatePKPass();
            if (!passBlob) return;
            // 打包pkpass为zip
            const zip = new JSZip();
            zip.file(`${currentPassName}.pkpass`, passBlob);
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            downloadFile(zipBlob, `${currentPassName}_pkpass.zip`, 'application/zip');
        });

        // 直接添加到钱包链接
        document.getElementById('addLink').addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentPassBlob) return;
            window.open(URL.createObjectURL(currentPassBlob), '_blank');
            alert('请在Safari新窗口中点击「添加」，即可将卡包加入苹果钱包');
        });
    </script>
</body>
</html>
