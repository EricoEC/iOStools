<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <!-- å…³é”®ï¼šè‹¹æœé’±åŒ…åŸç”Ÿè¯†åˆ«å¤´ -->
    <meta name="format-detection" content="telephone=no">
    <title>è‹¹æœé’±åŒ…å¡åŒ…ç”Ÿæˆå™¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif; }
        body { max-width: 800px; margin: 2rem auto; padding: 0 1rem; background: #f5f5f7; }
        .container { background: #fff; padding: 2.5rem; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #1d1d1f; margin-bottom: 2rem; font-size: 1.8rem; font-weight: 600; }
        .form-group { margin-bottom: 1.8rem; }
        label { display: block; margin-bottom: 0.7rem; font-weight: 600; color: #333; font-size: 0.95rem; }
        input, select, textarea, button { width: 100%; padding: 0.9rem 1.2rem; border: 1px solid #e5e5e7; border-radius: 10px; font-size: 1rem; background: #fff; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #0071e3; }
        textarea { min-height: 90px; resize: vertical; line-height: 1.5; }
        select { color: #333; cursor: pointer; }
        button { background: #0071e3; color: #fff; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        button:hover { background: #0077ed; }
        button:disabled { background: #a8a8a8; cursor: not-allowed; pointer-events: none; }
        .toggle-btn { background: #f5f5f7; color: #1d1d1f; margin-bottom: 1.5rem; }
        .toggle-btn:hover { background: #e8e8ed; }
        .advanced-group { display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px dashed #e5e5e7; }
        .preview { margin-top: 1rem; padding: 1rem; border: 1px solid #e5e5e7; border-radius: 8px; text-align: center; min-height: 80px; display: flex; align-items: center; justify-content: center; }
        .preview img { max-height: 80px; max-width: 100%; border-radius: 6px; margin: 0.5rem 0; }
        #debugInfo { margin: 1.5rem 0; padding: 1rem 1.2rem; border-radius: 8px; display: none; font-size: 0.95rem; line-height: 1.6; }
        .debug-success { background: #e6fffa; color: #26a69a; border: 1px solid #b2f5ea; }
        .debug-error { background: #ffebee; color: #e53935; border: 1px solid #ffcdd2; }
        .btn-group { display: flex; gap: 1.2rem; margin-top: 2rem; }
        .btn-group button { flex: 1; padding: 1rem; font-size: 1.05rem; }
        .action-link { display: block; text-align: center; margin-top: 1.5rem; color: #fff; background: #34c759; text-decoration: none; font-weight: 600; padding: 1rem; border-radius: 10px; transition: all 0.2s; }
        .action-link:hover { background: #30b752; }
        .action-link:disabled { background: #a8e5b4; cursor: not-allowed; pointer-events: none; }
        .must { color: #ff3b30; }
        .tip { color: #666; margin-top: 0.5rem; font-size: 0.85rem; line-height: 1.4; }
        .ios-tip { background: #fffbeb; border: 1px solid #ffe082; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; color: #f57c00; text-align: center; }
    </style>
    <!-- äºŒç»´ç /æ‰“åŒ…ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>è‹¹æœé’±åŒ…å¡åŒ…ç”Ÿæˆå™¨</h1>
        <!-- iOSä¸“å±æç¤º -->
        <div class="ios-tip">ğŸ“± iOSç”¨æˆ·ç›´æ¥ç‚¹ã€Œå”¤èµ·è‹¹æœé’±åŒ…ã€ï¼Œè‡ªåŠ¨å¼¹å‡ºæ·»åŠ å‡­è¯çª—å£ï¼Œæ— éœ€ä¸‹è½½ï¼</div>

        <!-- æ™®é€šæ¨¡å¼-å¿…å¡«é¡¹ -->
        <div class="form-group">
            <label for="passType">å¡åŒ…ç±»å‹ <span class="must">*</span></label>
            <select id="passType" required>
                <option value="membership">ä¼šå‘˜å¡</option>
                <option value="coupon">ä¼˜æƒ åˆ¸</option>
                <option value="eventTicket">é—¨ç¥¨</option>
                <option value="storeCard">å‚¨å€¼å¡</option>
            </select>
        </div>
        <div class="form-group">
            <label for="passName">é’±åŒ…å†…æ˜¾ç¤ºåç§° <span class="must">*</span></label>
            <input type="text" id="passName" placeholder="æ˜Ÿå·´å…‹ä¼šå‘˜å¡ã€XXæ»¡å‡ä¼˜æƒ åˆ¸" required>
            <div class="tip">æ·»åŠ åˆ°é’±åŒ…åï¼Œåˆ—è¡¨ä¸­æ˜¾ç¤ºçš„åç§°</div>
        </div>
        <div class="form-group">
            <label for="passTitle">å¡é¢ä¸»æ ‡é¢˜ <span class="must">*</span></label>
            <input type="text" id="passTitle" placeholder="å°Šè´µä¼šå‘˜ã€æ»¡100å‡50ã€XXæ¼”å”±ä¼šé—¨ç¥¨" required>
            <div class="tip">å¡åŒ…æ­£é¢æœ€å¤§çš„æ–‡å­—</div>
        </div>
        <div class="form-group">
            <label for="passCode">æ ¸å¿ƒç ï¼ˆå¡å·/åˆ¸ç /é—¨ç¥¨ç ï¼‰<span class="must">*</span></label>
            <input type="text" id="passCode" placeholder="1008611ã€YH2026001ã€NO.123456" required>
            <div class="tip">è‡ªåŠ¨ç”ŸæˆäºŒç»´ç /æ¡å½¢ç ï¼Œæ˜¾ç¤ºåœ¨å¡é¢æ ¸å¿ƒä½ç½®</div>
        </div>

        <!-- é«˜çº§æ¨¡å¼å¼€å…³ -->
        <button class="toggle-btn" id="advancedToggle">å±•å¼€é«˜çº§è‡ªå®šä¹‰ â–¼</button>

        <!-- é«˜çº§æ¨¡å¼-è‡ªå®šä¹‰é¡¹ -->
        <div class="advanced-group" id="advancedGroup">
            <div class="form-group">
                <label>å¡é¢é¢œè‰²é…ç½®</label>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <input type="text" id="bgColor" placeholder="èƒŒæ™¯è‰²" value="FF5722" maxlength="6" style="padding: 0.3rem; height: 45px; text-align: center;">
                    <input type="text" id="textColor" placeholder="æ–‡å­—è‰²" value="FFFFFF" maxlength="6" style="padding: 0.3rem; height: 45px; text-align: center;">
                    <input type="text" id="stripColor" placeholder="æ¡çº¹è‰²" value="E64A19" maxlength="6" style="padding: 0.3rem; height: 45px; text-align: center;">
                </div>
                <div class="tip">6ä½16è¿›åˆ¶è‰²å€¼ï¼ˆæ— #ï¼‰ï¼Œä¾‹ï¼šçº¢è‰²FF0000ã€ç™½è‰²FFFFFF</div>
            </div>

            <div class="form-group">
                <label for="logoUpload">å¡é¢Logoï¼ˆ100x100 PNGé€æ˜ï¼Œ<100KBï¼‰</label>
                <input type="file" id="logoUpload" accept="image/png">
                <div class="preview" id="logoPreview">Logoé¢„è§ˆï¼ˆé€æ˜PNGæœ€ä½³ï¼‰</div>
            </div>
            <div class="form-group">
                <label for="stripUpload">å¡é¢æ¡çº¹å›¾ï¼ˆ640x100 PNGï¼Œ<150KBï¼‰</label>
                <input type="file" id="stripUpload" accept="image/png">
                <div class="preview" id="stripPreview">æ¡çº¹å›¾é¢„è§ˆï¼ˆå¡é¢é¡¶éƒ¨æ¡çº¹ï¼‰</div>
            </div>

            <div class="form-group">
                <label for="passSubtitle">å¡é¢å‰¯æ ‡é¢˜</label>
                <input type="text" id="passSubtitle" placeholder="å…¨å›½é€šç”¨ã€2026å¹´æœ‰æ•ˆã€VIPä¸“äº«">
            </div>
            <div class="form-group">
                <label for="passDescription">å¡åŒ…è¯¦æƒ…æè¿°</label>
                <textarea id="passDescription" placeholder="æœ¬ä¼šå‘˜å¡ä¸ºXXå“ç‰Œé€šç”¨å‡­è¯ï¼Œå‡­ç äº«8æŠ˜ä¼˜æƒ ï¼›ä¼˜æƒ åˆ¸æœ‰æ•ˆæœŸè‡³2026.12.31ï¼Œä¸ä¸å…¶ä»–æ´»åŠ¨å åŠ "></textarea>
                <div class="tip">æ·»åŠ åˆ°é’±åŒ…åï¼Œç‚¹å‡»ã€Œiã€å›¾æ ‡æ˜¾ç¤ºçš„è¯¦æƒ…</div>
            </div>

            <div class="form-group">
                <label for="expireDate">å¡åŒ…æœ‰æ•ˆæœŸ</label>
                <input type="date" id="expireDate">
                <div class="tip">ä¸å¡«åˆ™æ°¸ä¹…æœ‰æ•ˆï¼Œè¿‡æœŸåé’±åŒ…ä¼šæç¤ºå¤±æ•ˆ</div>
            </div>

            <div class="form-group">
                <label for="codeType">ç å›¾ç±»å‹</label>
                <select id="codeType">
                    <option value="QR_CODE">äºŒç»´ç ï¼ˆæ¨èï¼‰</option>
                    <option value="CODE_128">æ¡å½¢ç ï¼ˆCODE_128ï¼‰</option>
                </select>
            </div>

            <div class="form-group">
                <label for="auxField1">è¾…åŠ©å­—æ®µ1</label>
                <input type="text" id="auxField1" placeholder="é—¨åº—åœ°å€ï¼šåŒ—äº¬å¸‚æœé˜³åŒºXXè·¯ï¼ˆæ ¼å¼ï¼šæ ‡ç­¾ï¼šå†…å®¹ï¼‰">
            </div>
            <div class="form-group">
                <label for="auxField2">è¾…åŠ©å­—æ®µ2</label>
                <input type="text" id="auxField2" placeholder="å’¨è¯¢ç”µè¯ï¼š400-000-0000">
            </div>
        </div>

        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div id="debugInfo"></div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="btn-group">
            <button id="createBtn">ç”Ÿæˆå¡åŒ…æ–‡ä»¶</button>
            <button id="exportZipBtn">å¯¼å‡ºZIPåŒ…ï¼ˆæ¡Œé¢ç«¯ï¼‰</button>
        </div>

        <!-- æ ¸å¿ƒå”¤èµ·æŒ‰é’® -->
        <a href="javascript:;" id="callWallet" class="action-link" disabled>ğŸ“± å”¤èµ·è‹¹æœé’±åŒ…ï¼ˆiOSä¸“å±ï¼‰</a>
    </div>

    <script>
        let pkpassBlob = null;
        let pkpassFileName = '';
        // é«˜çº§æ¨¡å¼åˆ‡æ¢
        const advancedToggle = document.getElementById('advancedToggle');
        const advancedGroup = document.getElementById('advancedGroup');
        advancedToggle.addEventListener('click', () => {
            const isOpen = advancedGroup.style.display === 'block';
            advancedGroup.style.display = isOpen ? 'none' : 'block';
            advancedToggle.textContent = isOpen ? 'å±•å¼€é«˜çº§è‡ªå®šä¹‰ â–¼' : 'æ”¶èµ·é«˜çº§è‡ªå®šä¹‰ â–²';
        });

        // è‹¹æœå®˜æ–¹å¿…å¤‡é»˜è®¤å›¾æ ‡ï¼ˆè§£å†³é—®å·ï¼Œå›ºå®šå°ºå¯¸ï¼‰
        const DEFAULT_ICONS = {
            icon: 'iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOk9wZW4gYmFzZWxpbmU9IjEwIiBzdHJva2U9IiM0NDQ0NDQiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48L3RpZmY6T3Blbj4KICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+',
            logo: 'iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFHGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOk9wZW4gYmFzZWxpbmU9IjE1IiBzdHJva2U9IiMwMDcwZmUiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48L3RpZmY6T3Blbj4KICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+',
            strip: 'iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFnElUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgICAgIDx0aWZmOkNvbXByZXNzaW9uPjE8L3RpZmY6Q29tcHJlc3Npb24+CiAgICAgICAgIDx0aWZmOk9wZW4gYmFzZWxpbmU9IjEwMCIgc3Ryb2tlPSIjRkY1NzIyIiBzdHJva2Utd2lkdGg9IjEwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIj48L3RpZmY6T3Blbj4KICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+'
        };

        // å›¾ç‰‡è½¬Base64+é¢„è§ˆï¼ˆä¸¥æ ¼é™åˆ¶PNG/å¤§å°ï¼‰
        function imgToBase64(fileInput, previewEl, maxSize) {
            return new Promise((resolve, reject) => {
                const file = fileInput.files[0];
                if (!file) return resolve('');
                if (file.type !== 'image/png') return reject('ä»…æ”¯æŒPNGæ ¼å¼å›¾ç‰‡ï¼');
                if (file.size > maxSize) return reject(`å›¾ç‰‡è¶…è¿‡${maxSize/1024}KBï¼Œè¯·å‹ç¼©ï¼`);
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewEl.innerHTML = `<img src="${e.target.result}" alt="é¢„è§ˆ">`;
                    resolve(e.target.result.split(',')[1]);
                };
                reader.onerror = (err) => reject(`å›¾ç‰‡è§£æå¤±è´¥ï¼š${err.message}`);
                reader.readAsDataURL(file);
            });
        }
        // ç»‘å®šå›¾ç‰‡é¢„è§ˆ
        document.getElementById('logoUpload').addEventListener('change', () => imgToBase64(document.getElementById('logoUpload'), document.getElementById('logoPreview'), 100*1024));
        document.getElementById('stripUpload').addEventListener('change', () => imgToBase64(document.getElementById('stripUpload'), document.getElementById('stripPreview'), 150*1024));

        // ç”Ÿæˆå”¯ä¸€IDï¼ˆè‹¹æœè§„èŒƒè¦æ±‚ï¼‰
        function generateUniqueId() {
            return 'P' + Math.random().toString(36).slice(2, 18) + Date.now().toString(36);
        }
        // è§£æè¾…åŠ©å­—æ®µ
        function parseAuxField(str) {
            if (!str || !str.includes('ï¼š')) return null;
            const [label, value] = str.split('ï¼š').map(v => v.trim());
            return label && value ? { label, value } : null;
        }

        // ç”Ÿæˆè‹¹æœå®˜æ–¹è§„èŒƒpass.json
        async function generatePassJson() {
            // è·å–è¡¨å•å€¼
            const passType = document.getElementById('passType').value;
            const passName = document.getElementById('passName').value.trim();
            const passTitle = document.getElementById('passTitle').value.trim();
            const passCode = document.getElementById('passCode').value.trim();
            const bgColor = document.getElementById('bgColor').value.trim() || 'FF5722';
            const textColor = document.getElementById('textColor').value.trim() || 'FFFFFF';
            const stripColor = document.getElementById('stripColor').value.trim() || 'E64A19';
            const passSubtitle = document.getElementById('passSubtitle').value.trim();
            const passDescription = document.getElementById('passDescription').value.trim() || `${passName} - è‹¹æœé’±åŒ…å¡åŒ…`;
            const expireDate = document.getElementById('expireDate').value;
            const codeType = document.getElementById('codeType').value;
            const auxField1 = parseAuxField(document.getElementById('auxField1').value);
            const auxField2 = parseAuxField(document.getElementById('auxField2').value);
            // å›¾ç‰‡Base64ï¼ˆæ— åˆ™ç”¨é»˜è®¤ï¼‰
            const logoBase64 = await imgToBase64(document.getElementById('logoUpload'), document.getElementById('logoPreview'), 100*1024).catch(() => DEFAULT_ICONS.logo);
            const stripBase64 = await imgToBase64(document.getElementById('stripUpload'), document.getElementById('stripPreview'), 150*1024).catch(() => DEFAULT_ICONS.strip);

            // æ„é€ è‹¹æœå®˜æ–¹è§„èŒƒç»“æ„
            const passJson = {
                formatVersion: 1, // å›ºå®šå€¼ï¼Œä¸å¯æ”¹
                passTypeIdentifier: `pass.com.${generateUniqueId().toLowerCase()}`,
                serialNumber: generateUniqueId(),
                teamIdentifier: 'T' + Math.floor(Math.random() * 9999999999).toString(),
                organizationName: 'å¡åŒ…ç”Ÿæˆå™¨',
                description: passDescription,
                backgroundColor: `#${bgColor}`,
                foregroundColor: `#${textColor}`,
                stripColor: `#${stripColor}`,
                barcodes: [{
                    format: codeType,
                    message: passCode,
                    messageEncoding: 'UTF-8',
                    altText: passCode
                }],
                [passType]: {
                    primaryFields: [
                        { key: 'title', label: '', value: passTitle, displayPriority: 0 },
                        { key: 'code', label: 'ç ', value: passCode, displayPriority: 1 }
                    ],
                    secondaryFields: [],
                    auxiliaryFields: []
                }
            };
            // è¿½åŠ å‰¯æ ‡é¢˜/æœ‰æ•ˆæœŸ/è¾…åŠ©å­—æ®µ
            if (passSubtitle) passJson[passType].secondaryFields.push({ key: 'sub', label: '', value: passSubtitle, displayPriority: 2 });
            if (expireDate) passJson.expirationDate = new Date(expireDate).toISOString();
            if (auxField1) passJson[passType].auxiliaryFields.push({ key: 'aux1', label: auxField1.label, value: auxField1.value, displayPriority: 3 });
            if (auxField2) passJson[passType].auxiliaryFields.push({ key: 'aux2', label: auxField2.label, value: auxField2.value, displayPriority: 4 });

            return { passJson, logoBase64, stripBase64, passName };
        }

        // æ ¸å¿ƒç”ŸæˆPKPassï¼ˆè‹¹æœè§„èŒƒï¼šZIPæ”¹åç¼€ï¼Œä½å‹ç¼©ï¼‰
        async function generatePKPass() {
            const debugEl = document.getElementById('debugInfo');
            debugEl.style.display = 'block';
            try {
                // æ ¡éªŒå¿…å¡«é¡¹
                const pn = document.getElementById('passName').value.trim();
                const pt = document.getElementById('passTitle').value.trim();
                const pc = document.getElementById('passCode').value.trim();
                if (!pn || !pt || !pc) {
                    debugEl.className = 'debug-error';
                    debugEl.textContent = 'âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼ˆç±»å‹ã€åç§°ã€ä¸»æ ‡é¢˜ã€æ ¸å¿ƒç ï¼‰';
                    return null;
                }

                // ç”Ÿæˆjsonå’Œèµ„æº
                const { passJson, logoBase64, stripBase64, passName } = await generatePassJson();
                const zip = new JSZip();
                // å†™å…¥æ ¸å¿ƒæ–‡ä»¶ï¼ˆè‹¹æœè¦æ±‚å›ºå®šæ–‡ä»¶åï¼‰
                zip.file('pass.json', JSON.stringify(passJson, null, 2), { encoding: 'utf8' });
                zip.file('icon.png', DEFAULT_ICONS.icon, { base64: true }); // å¿…å¤‡ï¼Œä¸å¯æ”¹
                zip.file('logo.png', logoBase64, { base64: true });
                zip.file('strip.png', stripBase64, { base64: true });

                // ç”ŸæˆBlobï¼ˆå…³é”®ï¼šè‹¹æœå®˜æ–¹MIMEç±»å‹ï¼Œä½å‹ç¼©ï¼‰
                pkpassFileName = `${passName.replace(/[^\w\u4e00-\u9fa5]/g, '')}.pkpass`;
                pkpassBlob = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 1 }, // è‹¹æœè¦æ±‚ä½å‹ç¼©
                    mimeType: 'application/vnd.apple.pkpass' // å›ºå®šMIMEï¼ŒåŸç”Ÿè¯†åˆ«
                });

                // ç”ŸæˆæˆåŠŸ
                debugEl.className = 'debug-success';
                debugEl.textContent = 'âœ… å¡åŒ…ç”ŸæˆæˆåŠŸï¼iOSç‚¹ã€Œå”¤èµ·è‹¹æœé’±åŒ…ã€ç›´æ¥æ·»åŠ ';
                document.getElementById('callWallet').removeAttribute('disabled');
                return pkpassBlob;
            } catch (e) {
                debugEl.className = 'debug-error';
                debugEl.textContent = `âŒ ç”Ÿæˆå¤±è´¥ï¼š${e.message}`;
                return null;
            }
        }

        // å”¤èµ·è‹¹æœé’±åŒ…ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç§»é™¤downloadï¼Œç”¨createObjectURLåŸç”Ÿå”¤èµ·ï¼‰
        function callAppleWallet() {
            if (!pkpassBlob) return;
            // å…³é”®ï¼šåˆ›å»ºä¸´æ—¶URLï¼ŒåŸç”Ÿæ‰“å¼€è€Œéä¸‹è½½
            const url = URL.createObjectURL(new Blob([pkpassBlob], { type: 'application/vnd.apple.pkpass' }));
            // æ–°å¼€çª—å£å”¤èµ·åŸç”Ÿå‡­è¯å¼¹çª—
            const win = window.open(url, '_blank');
            // å»¶æ—¶é‡Šæ”¾URLï¼Œé¿å…å†…å­˜æ³„æ¼
            setTimeout(() => {
                URL.revokeObjectURL(url);
                win.close();
            }, 3000);
        }

        // å¯¼å‡ºZIPï¼ˆæ¡Œé¢ç«¯å…¼å®¹ï¼‰
        async function exportZip() {
            if (!pkpassBlob) {
                const res = await generatePKPass();
                if (!res) return;
            }
            const zip = new JSZip();
            zip.file(pkpassFileName, pkpassBlob);
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            // æ¡Œé¢ç«¯ä¸‹è½½ZIP
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${pkpassFileName.replace('.pkpass', '')}_å¡åŒ…æ–‡ä»¶.zip`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('createBtn').addEventListener('click', generatePKPass);
        document.getElementById('exportZipBtn').addEventListener('click', exportZip);
        document.getElementById('callWallet').addEventListener('click', callAppleWallet);
    </script>
</body>
</html>
